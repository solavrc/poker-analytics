version: 2

models:
  - name: stg_hand_events
    description: >
      ポーカーハンドのイベントデータを格納するステージングモデル。
      各イベントは、ハンドの進行状況 (開始、ストリートの開始、カードの配布、プレイヤーのアクション、結果) を表す。

      主なイベントタイプ:
      - EVT_DEAL (303): ハンドの開始。プレイヤーへのホールカードの配布。SeatUserIdsの記録。
      - EVT_ACTION (304): プレイヤーのアクション (FOLD, CHECK, CALL, BET, RAISE, ALL_IN) 。
      - EVT_DEAL_ROUND (305): 新しいストリートの開始とコミュニティカードの配布。
      - EVT_HAND_RESULTS (306): ハンドの終了。勝者とリワードの決定。

      典型的なイベントシーケンス:
      1. プリフロップ
         - EVT_DEAL: ハンド開始、ホールカード配布
         - EVT_ACTION: SB、BB、その他プレイヤーのアクション
      2. フロップ
         - EVT_DEAL_ROUND: フロップカード (3枚) の配布
         - EVT_ACTION: 残っているプレイヤーのアクション
      3. ターン
         - EVT_DEAL_ROUND: ターンカード (1枚) の配布
         - EVT_ACTION: 残っているプレイヤーのアクション
      4. リバー
         - EVT_DEAL_ROUND: リバーカード (1枚) の配布
         - EVT_ACTION: 残っているプレイヤーのアクション
      5. 終了
         - EVT_HAND_RESULTS: 勝者の決定、報酬の分配

      エッジケース:
      - プレイヤーの切断: アクションの順序が乱れる可能性。タイムアウトまで待機。
      - タイムバンク: 長考の場合、イベント間隔が通常より長くなる。
      - オールイン: 以降のストリートでアクションイベントが発生しない。
      - 早期終了: 全員がフォールドした場合、以降のDEAL_ROUNDイベントが発生しない。
      - 同時切断: 複数プレイヤーが同時に切断した場合、イベントの順序が不定になる。

      注意事項:
      - hand_idはEVT_HAND_RESULTSイベントでのみ設定され、他のイベントではNULLとなる。
      - 同一ハンド内でのイベントの順序は、event_timestampとhand_sequenceで保証される。
      - プレイヤーの切断やタイムアウトにより、イベントが欠落する可能性がある。
      - 60秒以上のイベント間隔がある場合、異常とみなされる。
    columns:
      - name: event_timestamp
        description: >
          イベントが発生した時刻。
          同一ハンド内でのイベントの順序を決定する主要な基準となる。
        tests:
          - not_null

      - name: sender_user_id
        description: ログ送信者のユーザーID
        tests:
          - not_null

      - name: hand_id
        description: ハンドID。EVT_DEALからEVT_HAND_RESULTSまでの一連のイベントを識別する。
        tests:
          - not_null:
              where: "has_invalid_interval = 0 and ApiTypeId = 306"

      - name: hand_sequence
        description: >
          ハンド内でのイベントの連番。
          event_timestampと組み合わせて、イベントの正確な順序を保証する。
        tests:
          - not_null
          - positive_value

      - name: is_hand_start
        description: ハンド開始フラグ
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: is_hand_end
        description: ハンド終了フラグ
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: has_invalid_interval
        description: 無効なイベント間隔の有無
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: ApiTypeId
        description: >
          イベントの種類を示すID。
          303: EVT_DEAL - ハンドの開始とホールカードの配布
          304: EVT_ACTION - プレイヤーのアクション
          305: EVT_DEAL_ROUND - 新しいストリートの開始
          306: EVT_HAND_RESULTS - ハンドの終了と結果
        tests:
          - not_null

      - name: action_type
        description: アクションの種類（0:チェック, 1:ベット, 2:フォールド, 3:コール, 4:レイズ, 5:オールイン）

      - name: seat_index
        description: プレイヤーの着席位置

      - name: next_action_seat
        description: 次のアクションのシート番号（-2:ハンド終了, -1:フェーズ終了, 0-5:シート番号）

      - name: button_seat
        description: ボタンの位置

      - name: sb_seat
        description: スモールブラインドの位置

      - name: bb_seat
        description: ビッグブラインドの位置

      - name: sb
        description: スモールブラインドの額

      - name: bb
        description: ビッグブラインドの額

      - name: ante
        description: アンティの額（0の場合もあり）

      - name: current_blind_lv
        description: 現在のブラインドレベル
