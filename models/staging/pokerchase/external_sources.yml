version: 2

sources:
  - name: pokerchase
    description: >
      PokerChaseのAPIイベントデータ
      `$ dbt run-operation stage_external_sources --vars "ext_full_refresh: true"`
    schema: POKERCHASE
    loaded_at_field: loaded_at

    tables:
      - name: raw_api_events
        description: >
          PokerChaseのAPIイベントデータ。
          ハンドの開始、フェーズの開始、カードの配布、プレイヤーのアクション、ハンドの結果などを含む。

          dbt run-operation stage_external_sources --vars "ext_full_refresh: true"

        external:
          location: "@POKER_ANALYTICS.POKERCHASE.S3_EXTERNAL_POKERCHASE_STAGE"
          file_format: array_json_format
          # pattern: .*[.]json
          pattern: .*2025-01-21T00:00:00.000Z.test_tournament.json
          partitions:
            - name: sender_user_id
              description: イベントを送信したユーザーのID
              data_type: number
              expression: TO_NUMBER(SPLIT_PART(metadata$filename, '/', 2))
            - name: loaded_at
              description: イベントを取り込んだ日付
              data_type: date
              expression: TO_DATE(SUBSTR(SPLIT_PART(metadata$filename, '/', 3), 0, 10))

        columns:
          - name: row_number
            description: ファイル内の行番号
            data_type: number
            expression: metadata$file_row_number

          - name: timestamp
            data_type: number
            description: UNIXタイムスタンプ (ミリ秒)

          - name: event_timestamp
            data_type: timestamp_ntz
            description: イベントのタイムスタンプ
            expression: TO_TIMESTAMP_NTZ(timestamp, 3)

          - name: ApiTypeId
            alias: api_type_id
            data_type: number
            description: APIイベントタイプ

          - name: ApiType
            alias: api_type
            data_type: varchar
            expression: >
              CASE api_type_id
                WHEN 201 THEN 'RES_ENTRY_QUEUED'
                WHEN 202 THEN 'RES_ACTION_COMPLETED'
                WHEN 203 THEN 'RES_ENTRY_CANCEL_QUEUED'
                WHEN 204 THEN 'RES_HAND_STARTED'
                WHEN 205 THEN 'RES_TIME_REMAINED'
                WHEN 206 THEN 'RES_STAMP_SENT'
                WHEN 210 THEN 'RES_OPEN_FOLDED_HAND'
                WHEN 212 THEN 'RES_LEAVE_COMPLETED'
                WHEN 213 THEN 'RES_ENTRY_CANCELED'
                WHEN 214 THEN 'RES_ADDON_COMPLETED'
                WHEN 215 THEN 'RES_ADDON_READY'
                WHEN 301 THEN 'EVT_PLAYER_JOIN'
                WHEN 303 THEN 'EVT_DEAL'
                WHEN 304 THEN 'EVT_ACTION'
                WHEN 305 THEN 'EVT_DEAL_ROUND'
                WHEN 306 THEN 'EVT_HAND_RESULTS'
                WHEN 307 THEN 'EVT_SESSION_STARTED'
                WHEN 308 THEN 'EVT_SESSION_DETAILS'
                WHEN 309 THEN 'EVT_SESSION_RESULTS'
                WHEN 310 THEN 'EVT_STAMP_RECEIVED'
                WHEN 311 THEN 'EVT_HAND_COMPLETED'
                WHEN 313 THEN 'EVT_PLAYER_SEAT_ASSIGNED'
                WHEN 314 THEN 'EVT_REWARD_CHANGED'
                WHEN 317 THEN 'EVT_BLIND_RAISED'
                WHEN 319 THEN 'EVT_ENTRY_COMPLETED'
              END
            description: >
              主なイベントタイプ:

              308: EVT_SESSION_DETAILS
                トーナメントやリングゲームの設定情報。
                例:
                {"ApiTypeId":308,
                 "BlindStructures":[
                   {"ActiveMinutes":3,"Ante":50,"BigBlind":200,"Lv":1},
                   {"ActiveMinutes":3,"Ante":70,"BigBlind":280,"Lv":2},
                   ... 省略 ...
                 ],
                 "DefaultChip":30000,
                 "IsReplay":true,
                 "Name":"ステージⅥ",
                 "timestamp":1737297251276}

              303: EVT_DEAL
                ハンドの起点。
                例:
                {"ApiTypeId":303,
                 "Game":{"Ante":50,"BigBlind":200,"ButtonSeat":5,"SmallBlind":100},
                 "OtherPlayers":[
                   {"BetChip":100,"SeatIndex":0,"Chip":29850,"Status":0},
                   ...
                 ],
                 "Player":{"HoleCards":[5,34],"SeatIndex":3,"Chip":29950},
                 "SeatUserIds":[639171155,900323435,620868655,-1,166317878,898959592],
                 "timestamp":1737297260863}

              304: EVT_ACTION
                ハンドのアクション。
                例:
                {"ApiTypeId":304,
                 "ActionType":4,"BetChip":600,"Chip":29350,"SeatIndex":2,
                 "Progress":{"Pot":1200,"Phase":0},
                 "timestamp":1737297266967}

              305: EVT_DEAL_ROUND
                コミュニティカード公開などストリート進行。
                例:
                {"ApiTypeId":305,
                 "CommunityCards":[23,9,40],
                 "Progress":{"Pot":1700,"Phase":1},
                 "timestamp":1737297275773}

              306: EVT_HAND_RESULTS
                ハンドの結果。HandIdを取得できる唯一の機会。
                例:
                {"ApiTypeId":306,
                 "HandId":306377888,
                 "Pot":1700,
                 "Results":[
                   {"Hands":[23,22,50,47,40],"HoleCards":[14,50],"RewardChip":850,"UserId":639171155},
                   ...
                 ],
                 "timestamp":1737297296662}

              309: EVT_SESSION_RESULTS
                トーナメントやリングゲームの最終結果通知など。
                例:
                {"ApiTypeId":309,
                 "BattleFinishTime":1737299195,
                 "Ranking":1,
                 "timestamp":1737299195132}

          - name: HandId
            alias: hand_id
            data_type: number
            description: >
              ハンドを識別するID
              `EVT_HAND_RESULTS`にのみ存在する。

          - name: OtherPlayers
            alias: other_players
            data_type: array
            description: >
              テーブルに着席中のプレイヤー
                BetStatus: ベットのステータス
                BetChip: ベットしたチップ数
                Chip: プレイヤーの残りチップ量
                SeatIndex: プレイヤーのシート番号
                Status: プレイヤーのステータス

          - name: Player
            alias: player
            data_type: variant
            description: >
              プレイヤーの情報
                BetChip: ベットしたチップ数
                BetStatus: ベットのステータス
                Chip: プレイヤーの残りチップ量
                HoleCards: プレイヤーの手札
                SeatIndex: プレイヤーのシート番号

          - name: Progress
            alias: progress
            data_type: variant
            description: >
              ハンドの進行状況
                Phase: フェーズ
                  0: PREFLOP
                  1: FLOP
                  2: TURN
                  3: RIVER
                NextActionSeat: 次のアクションのシート番号
                  -2: ハンド終了
                  -1: フェーズ終了
                  0-5: シート番号
                Pot: 現在のポットサイズ
                BetChip: ベットしたチップ数
                Chip: プレイヤーの残りチップ量
                SidePot: サイドポットのサイズ

          - name: ActionType
            alias: action_type
            data_type: number
            description: >
              0: CHECK
              1: BET
              2: FOLD
              3: CALL
              4: RAISE
              5: ALL_IN

          - name: BetChip
            alias: bet_chip
            data_type: number
            description: プレイヤーのベットしたチップ数

          - name: Chip
            alias: chip
            data_type: number
            description: プレイヤーのチップ数

          - name: SeatIndex
            alias: seat_index
            data_type: number
            description: プレイヤーのシート番号

          - name: Game
            alias: game
            data_type: variant
            description: >
              ゲーム情報
                ButtonSeat: ボタンのシート番号
                SmallBlindSeat: SBのシート番号
                BigBlindSeat: BBのシート番号
                SmallBlind: SBの額
                BigBlind: BBの額
                Ante: アンティの額
                CurrentBlindLv: 現在のブラインドレベル
                NextBlindUnixSeconds: 次のブラインドのUNIXタイムスタンプ

          - name: SeatUserIds
            alias: seat_user_ids
            data_type: array
            description: 各シートのプレイヤーID (配列)

          - name: CommunityCards
            alias: community_cards
            data_type: array
            description: コミュニティカード (配列)

          - name: Results
            alias: results
            data_type: array
            description: >
              ハンドの結果 (配列)
                UserId: プレイヤーID
                HoleCards: 手札
                RankType: 完成した役のランク (0-12)
                HandRanking: ハンド内の順位
                RewardChip: 獲得チップ
                Ranking: 最終順位（トーナメント）

              サンプルクエリ:
                SELECT e.hand_id, r.VALUE
                FROM POKER_ANALYTICS.POKERCHASE.RAW_API_EVENTS e, LATERAL FLATTEN(input => e.Results) r
                WHERE api_type_id = 306

          - name: Name
            alias: name
            data_type: varchar
            description: >
              イベント名
              例: 6人対戦【STAGEⅥ】

          - name: TableUsers
            alias: table_users
            data_type: array
